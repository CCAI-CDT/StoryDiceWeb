<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Story Dice - STAR Model</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes pulse-go { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .pulse-go { animation: pulse-go 1.5s ease-in-out infinite; }
    .prompt {
      background-color: grey;
      border-radius: 0.5rem;
      padding: 0.1rem 0.3rem;
      color: white;
    }
    .character { background-color: #3b82f6; } /* blue-500 */
    .adjective { background-color: #facc15; } /* yellow-500 */
    .tone { background-color: #ef4444; } /* red-500 */
    .role { background-color: #22c55e; } /* green-500 */
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const options = {
      character: ['Car', 'Alien', 'Astronaut', 'Dinosaur', 'Scientist', 'Dog'],
      adjective: ['Magical', 'Smart', 'Brave', 'Friendly', 'Curious', 'Giant'],
      tone: ['Silly', 'Happy', 'Mysterious', 'Boring', 'Educational', 'Surprising'],
      role: ['A Toddler', 'Teacher', 'Scientist', 'Robot', 'News Reporter', 'Grandmother']
    };

    const starLabels = {
      character: { letter: 'S', word: 'Specific', desc: 'Who is in your story?' },
      adjective: { letter: 'S', word: 'Specific', desc: 'What are they like?' },
      tone: { letter: 'T', word: 'Tone', desc: 'How does it feel?' },
      role: { letter: 'R', word: 'Role', desc: 'Who tells the story?' }
    };

    const colors = {
      character: { bg: 'bg-blue-500', light: 'bg-blue-100', border: 'border-blue-400', text: 'text-blue-700' },
      adjective: { bg: 'bg-yellow-500', light: 'bg-yellow-100', border: 'border-yellow-400', text: 'text-black-700' },
      tone: { bg: 'bg-red-500', light: 'bg-red-100', border: 'border-red-400', text: 'text-red-700' },
      role: { bg: 'bg-green-500', light: 'bg-green-100', border: 'border-green-400', text: 'text-green-700' }
    };

    const DiceIcon = ({ rolling }) => (
      <svg className={`w-5 h-5 ${rolling ? 'animate-spin' : ''}`} viewBox="0 0 24 24" fill="currentColor">
        <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" strokeWidth="2" fill="none"/>
        <circle cx="8" cy="8" r="1.5"/><circle cx="16" cy="8" r="1.5"/>
        <circle cx="8" cy="16" r="1.5"/><circle cx="16" cy="16" r="1.5"/>
        <circle cx="12" cy="12" r="1.5"/>
      </svg>
    );

    const DiceSection = ({ type, selected, onSelect, onRoll, rolling }) => {
  const c = colors[type];
  const label = starLabels[type];

  // Simplified selected view
  if (selected) {
    return (
      <div className={`${c.light} rounded-2xl p-4 border-2 ${c.border} h-fit`}>
        <div className="flex items-center justify-between mb-2">
          <span className={`${c.bg} text-white font-bold px-2 py-2 rounded-lg text-sm`}>
            {label.letter} = {label.word}
          </span>
          <span className={`${c.text} font-semibold capitalize text-sm`}>{type}</span>
        </div>
        <div className="text-center pb-6">
          <p className={`${c.text} text-3xl font-bold mb-4`}>{selected}</p>
          <button
            onClick={() => onSelect(null)}
            className={`${c.bg} text-white px-4 py-2 rounded-lg font-medium hover:opacity-90 transition-all`}
            data-action={type.toLowerCase() + '-clear'}
          >
            Clear Selection
          </button>
        </div>
      </div>
    );
  }

  // Original full view with all options
  return (
    <div className={`${c.light} rounded-2xl p-4 border-2 ${c.border} h-fit`}>
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className={`${c.bg} text-white font-bold px-2 py-2 rounded-lg text-sm`}>
            {label.letter} = {label.word}
          </span>
          <span className={`${c.text} font-semibold capitalize`}>{type}</span>
        </div>
        <button
          onClick={onRoll}
          disabled={rolling}
          className={`${c.bg} text-white px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 hover:opacity-90 transition-all ${rolling ? 'scale-110' : ''}`}
        >
          <DiceIcon rolling={rolling} /> Roll!
        </button>
      </div>
      <p className={`${c.text} text-sm mb-2 opacity-75`}>{label.desc}</p>
      <div className="grid grid-cols-3 gap-2">
        {options[type].map((opt) => (
          <button
            key={opt}
            onClick={() => onSelect(opt)}
            className={`px-2 py-2 rounded-xl text-sm font-medium transition-all transform hover:scale-105 bg-white text-gray-700 hover:bg-gray-50 border border-gray-200`}
            data-action={type.toLowerCase() + '-' + opt.toLowerCase().replaceAll(' ', '_')}
          >
            {opt}
          </button>
        ))}
      </div>
    </div>
  );
};

  const ReadAloudButton = ({ text }) => {
    const [speaking, setSpeaking] = useState(false);

     const handleSpeak = () => {
    if (speaking) {
      window.speechSynthesis.cancel();
      setSpeaking(false);
      return;
    }

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 0.9; 
    utterance.pitch = 1.1; 
    
    utterance.onend = () => setSpeaking(false);
    utterance.onerror = () => setSpeaking(false);

    setSpeaking(true);
    window.speechSynthesis.speak(utterance);
  };

  return (
    <button
      onClick={handleSpeak}
      className={`mt-4 ml-2 px-4 py-2 rounded-xl font-bold transition-all ${
        speaking 
          ? 'bg-red-500 text-white hover:bg-red-600' 
          : 'bg-green-500 text-white hover:bg-green-600'
      }`}
    >
      {speaking ? '‚èπÔ∏è Stop' : 'üîä Read Aloud'}
    </button>
  );
};


    function AIStoryDice() {
      const [selections, setSelections] = useState({ character: null, adjective: null, tone: null, role: null });
      const [rolling, setRolling] = useState({});
      const [story, setStory] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [promptRecipe, setPromptRecipe] = useState('')

      // Start NFC
      useEffect(() => {
        runNfc();
      }, []);

      // Auto-generate hack
      let debounceTimeout = null;
      let redoRequired = false;
      let generating = false;
      function debounceTriggerGo() {
        console.log('Debounce trigger go...');
        if (debounceTimeout) clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          if (generating) {
            redoRequired = true;
          } else {
            // Press regenerate button
            const goButton = document.getElementById('go-button');
            if (goButton) goButton.click();
            const regenerateButton = document.getElementById('regenerate-button');
            if (regenerateButton) regenerateButton.click();
          }
        }, 1000);
      }

      const handleSelect = (type, value) => {
        setSelections(prev => ({ ...prev, [type]: value }));

        // Clearing old story
        setStory('')

        // Update prompt recipe
        // const selectionPlaceholders = {
        //   character: selections.character ? '$character' : '', 
        //   adjective: selections.adjective ? '$adjective' : '', 
        //   tone: selections.tone ? '$tone' : '', 
        //   role: selections.role ? '$role' : '',
        // }
        const prompt = buildPrompt(selections);
        console.log(prompt);
        setPromptRecipe('' + prompt);

        debounceTriggerGo();
      };

      const handleRoll = (type) => {
        setRolling(prev => ({ ...prev, [type]: true }));
        let count = 0;
        const interval = setInterval(() => {
          const randomOpt = options[type][Math.floor(Math.random() * 6)];
          setSelections(prev => ({ ...prev, [type]: randomOpt }));
          count++;
          if (count > 10) {
            clearInterval(interval);
            setRolling(prev => ({ ...prev, [type]: false }));
          }
        }, 100);
      };

      const rollAll = () => {
        ['character', 'adjective', 'tone', 'role'].forEach((type, i) => {
          setTimeout(() => handleRoll(type), i * 200);
        });
      };

      const buildPrompt = (selections, html) => {
        const { character, adjective, tone, role } = selections;
        const hasAny = character || adjective || tone || role;
        if (!hasAny) return null;

        let prompt = '';
        if (role) prompt += `You are <span class="prompt role">${role.toLowerCase()}</span> telling a story. `;
        else prompt += 'You are a storyteller. ';
        
        prompt += 'Write in exactly 3-4 sentences for children aged 7-10 about ';
        
        if (adjective && character) prompt += `a <span class="prompt adjective">${adjective.toLowerCase()}</span> <span class="prompt character">${character.toLowerCase()}</span>. `;
        else if (adjective) prompt += `something <span class="prompt adjective">${adjective.toLowerCase()}</span>. `;
        else if (character) prompt += `a <span class="prompt character">${character.toLowerCase()}</span>. `;
        else prompt += 'an adventure. ';
        
        if (tone) prompt += `Your story MUST be <span class="prompt tone">${tone.toLowerCase()}</span> - make sure the <span class="prompt tone">${tone.toLowerCase()}</span> feeling is very clear and obvious. `;
        
        prompt += 'Use simple words';
        if (role) prompt += ` and make your <span class="prompt role">${role.toLowerCase()}</span> personality shine through in how you tell the story`;
        prompt += '. Make this story completely different from any other story.';
        
        if (!html) {
          // Remove "<...>" spans
          prompt = prompt.replace(/<[^>]+>/g, '');
        }

        return prompt;
      };

      const generateStory = async () => {
        const prompt = buildPrompt(selections);
        if (!prompt) {
          setError('Please select at least one option!');
          return;
        }
        
        setLoading(true);
        generating = true;
        setError('');
        setStory('');
        
        try {
          const response = await fetch('http://localhost:1234/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: 'local-model',
              messages: [{ role: 'user', content: prompt }],
              temperature: 0.9,
              max_tokens: 200
            })
          });
          
          if (!response.ok) throw new Error('Could not connect to LM Studio');
          const data = await response.json();
          setStory(data.choices[0].message.content);
        } catch (err) {
          setError('Make sure LM Studio is running on localhost:1234!');

          // For testing, delay here
          await new Promise(res => setTimeout(res, 3000));
        }
        setLoading(false);
        generating = false;

        if (redoRequired) {
          redoRequired = false;
          generateStory();
        }
      };

      const hasSelection = true;//Object.values(selections).some(v => v);

      return (
        <div className="min-h-screen bg-gradient-to-br from-cyan-500 via-cyan-300 to-cyan-50 p-4">
          <div className="mx-auto">
            <div className="text-center mb-6">
              <h1 className="text-6xl font-black text-white mb-2 drop-shadow-lg">
                üé≤ AI Story Dice üé≤
              </h1>
              <p className="text-xl text-white">Learn the STAR Model of Prompt Engineering!</p>

              <div className="flex justify-center gap-2 mt-3 flex-wrap">
                <span className="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-bold">S = Specific</span>
                <span className="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold">T = Tone</span>
                <span className="bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold">A = Audience (7-10)</span>
                <span className="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">R = Role</span>
              </div>
            </div>

            
  
  


            <div className="flex flex-col xl:flex-row ml-8 mr-8">
              <div className="grid md:grid-cols-2 gap-4 mb-6 w-full xl:max-w-1/2 xl:mr-8 h-fit">
                <DiceSection type="character" selected={selections.character} onSelect={(v) => handleSelect('character', v)} onRoll={() => handleRoll('character')} rolling={rolling.character} />
                <DiceSection type="adjective" selected={selections.adjective} onSelect={(v) => handleSelect('adjective', v)} onRoll={() => handleRoll('adjective')} rolling={rolling.adjective} />
                <DiceSection type="tone" selected={selections.tone} onSelect={(v) => handleSelect('tone', v)} onRoll={() => handleRoll('tone')} rolling={rolling.tone} />
                <DiceSection type="role" selected={selections.role} onSelect={(v) => handleSelect('role', v)} onRoll={() => handleRoll('role')} rolling={rolling.role} />
                
                {hasSelection && (
                  <div className="md:col-span-2 bg-white/90 rounded-2xl p-4 shadow-lg">
                    <h3 className="font-bold text-gray-700 mb-2">üìù The Prompt We Send to the AI:</h3>
                    <div className="bg-gray-100 rounded-xl p-3 border-2 border-dashed border-gray-300">
                      <p className="text-gray-800 font-mono text-sm" dangerouslySetInnerHTML={{__html: buildPrompt(selections, true)}}></p>
                    </div>
                  </div>
                )}
              </div>

              <div className="flex flex-col w-full xl:max-w-1/2">
                <div className="flex flex-col w-full max-w-1/2">
                  <div className="bg-white rounded-3xl p-6 shadow-2xl border-4 border-yellow-400">
                    <h2 className="text-2xl font-black text-purple-700 mb-6">üìñ Your AI Story!</h2>
                    
                    {!story && (
                      <div className="flex justify-center gap-4 mb-6 flex-col items-center">
                        <button
                          onClick={rollAll}
                          className="bg-white text-purple-700 px-6 py-3 rounded-2xl font-bold text-lg hover:bg-purple-100 transition-all transform hover:scale-105 shadow-lg border-2 border-purple-300 w-64"
                        >
                          üé≤ Roll All Dice!
                        </button>
                        <button
                          onClick={generateStory}
                          disabled={loading || !hasSelection}
                          id="go-button"
                          className={`px-10 py-4 rounded-2xl font-black text-2xl transition-all transform shadow-xl w-64 ${
                            hasSelection && !loading
                              ? 'bg-gradient-to-r from-yellow-400 to-orange-500 text-white hover:scale-110 hover:shadow-2xl pulse-go'
                              : 'bg-gray-400 text-gray-200 cursor-not-allowed'
                          }`}
                        >
                          {loading ? '‚ú® Creating...' : '‚ñ∂Ô∏è GO!'}
                        </button>
                      </div>
                    )}
                    {story && (
                      <>
                        <p className="text-xl text-gray-800 leading-relaxed mb-4">{story}</p>
                        <div className="flex gap-2">
                          <button
                            id="regenerate-button"
                            onClick={generateStory}
                            className="bg-purple-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-purple-600"
                          >
                            üîÑ Generate Another!
                          </button>
                          <ReadAloudButton text={story} />
                        </div>
                      </>
                    )}
                  </div>
                {error && (
                  <div className="bg-red-100 border-2 border-red-400 text-red-700 rounded-2xl p-4 mt-4 text-center font-medium">
                    {error}
                  </div>
                )}
              </div>
            </div>
            </div>
            <div className="flex justify-center gap-4 mb-6">
              <div className="flex justify-center gap-4 mb-6">
                <button
                  onClick={() => {
                    setStory('');
                    setSelections({ character: null, adjective: null, tone: null, role: null });
                    setError('');
                  }}
                  className="bg-red-500 text-white px-6 py-3 rounded-2xl font-bold text-lg hover:bg-red-600 transition-all transform hover:scale-105 shadow-lg"
                >
                  üîÑ Reset
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<AIStoryDice />);


    // Log messages to console and, if present, a textarea
function nfcLog(message) {
    console.log(message);
    const textarea = document.querySelector('textarea');
    if (textarea) {
        textarea.value += message + '\n';
        textarea.scrollTop = textarea.scrollHeight;
    }
}

// Handle NFC events
function nfcEvent(event) {
    // const cardEvent = {
    //     source,     // Nfc
    //     reader,     // string
    //     id,         // string | ''
    //     previousId, // string | ''
    //     readers.    // { reader: id, ... }
    // };

    // Handle NFC events here
    //nfcLog(`Event received - Reader: ${event.reader}, ID: ${event.id} - State: ${JSON.stringify(event.readers)} - ExclusiveState: ${JSON.stringify(event.exclusiveState)}`);

    nfcLog(`${exclusives && event.notExclusive ? 'UNRECOGNIZED-' : ''}TAG: ${event.reader}, id=${event.id}`);

    // nfcLog exclusive state changes
    if (exclusives) {
        const overview = {}
        for (const [exclusiveId, state] of Object.entries(event.exclusiveState)) {
            const stateValue = state.value ? state.value : '';
            overview[exclusiveId] = stateValue;
            if (state.changed) {    // 'new', 'removed'
                nfcLog(`CHANGE: ${exclusiveId}=${stateValue} (reader=${state.reader} tag=${state.id} exclusive-index=${state.index} exclusive-value=${state.value})`);
                // Handle an exclusive tag-group change for: exclusiveId = stateValue
                if (!exclusiveId.startsWith('_')) {
                  const actionId = exclusiveId.toLowerCase() + '-' + (stateValue ? stateValue.toLowerCase().replaceAll(' ', '_') : 'clear');
                  const selector = '[data-action=' + actionId + ']';
                  const element = document.querySelector(selector);
                  if (!element) {
                    console.error('ERROR: Did not find automation element: ' + selector);
                  } else {
                    element.click();
                  }
                }
            }
        }
        nfcLog(`OVERVIEW: ${JSON.stringify(overview)}`);
    }
}

// Mapping of group label to array of tag IDs -- matching events and current group index will be determined
let exclusives = null;
// Character: ['Car', 'Alien', 'Astronaut', 'Dinosaur', 'Scientist', 'Dog'],
// Adjective: ['Magical', 'Smart', 'Brave', 'Friendly', 'Curious', 'Giant'],
// Tone: ['Silly', 'Happy', 'Mysterious', 'Boring', 'Educational', 'Surprising'],
// Role: ['A Toddler', 'Teacher', 'Scientist', 'Robot', 'News Reporter', 'Grandmother']
exclusives ={
    '_cards': { // for testing only
      '981e37b7': '1',
      '98231487': '2',
      '983fd4b7': '3',
      '98fd4597': '4',
      '98f458c7': '5',
    },
    'Character': {
      '397dde50': 'Car',
      '397de240': 'Alien',
      '397f4450': 'Astronaut',
      '397ecee0': 'Dinosaur',
      '12093a10': 'Scientist',
      '12093c00': 'Dog',

      '1208ee90': 'Car',
      '1208f190': 'Alien',
      '1208f660': 'Astronaut',
      '1208f320': 'Dinosaur',
      '1208f020': 'Scientist',
      '1208f4c0': 'Dog',


    },
    
    'Adjective': {
      '12091dd0': 'Magical',
      '12091f90': 'Smart',
      '12091a40': 'Brave',
      '12091bf0': 'Friendly',
      '12092140': 'Curious',
      '120918a0': 'Giant',

      '1208fce0': 'Magical',
      '1208ffe0': 'Smart',
      '1208f7e0': 'Brave',
      '1208f960': 'Friendly',
      '1208fe60': 'Curious',
      '1208fb30': 'Giant',



    },
    'Tone': {
      '12093630': 'Silly',
      '12093060': 'Happy',
      '12093450': 'Mysterious',
      '12093810': 'Boring',
      '12092e80': 'Educational',
      '12093230': 'Surprising',

      '12090340': 'Silly',
      '120904e0': 'Happy',
      '12090850': 'Mysterious',
      '12090690': 'Boring',
      '120901a0': 'Educational',
      '12090a10': 'Surprising',





    },
    'Role': {
      '12092530': 'A Toddler',
      '120928e0': 'Teacher',
      '12092ca0': 'Scientist',
      '12092320': 'Robot',
      '12092710': 'News Reporter',
      '12092aa0': 'Grandmother',

      '12090f70': 'A Toddler',
      '12090bd0': 'Teacher',
      '120914b0': 'Scientist',
      '120912e0': 'Robot',
      '12090d80': 'News Reporter',
      '120916c0': 'Grandmother',

    },
};

// Dynamically load a script (so we can tweak the NFC server address if required)
async function dynamicallyLoadScript(url) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`Failed to load script: ${url}`));
        document.head.appendChild(script);
    });
}

// Load the NFC script and start the NFC connection
async function runNfc() {
    try {
        let protocolSecure = location.protocol === 'https:' ? 's' : '';
        let hostname = location.hostname;
        let port = location.port;

        // Override the address of the NFC server
        if (!hostname) {    // e.g. file: protocol
            hostname = '127.0.0.1';  // 'localhost'
        }
        protocolSecure = '';    // force non-secure
        port = 5001;

        const scriptUrl = `http${protocolSecure}://${hostname}:${port}/nfc.js`;
        const connectionString = `ws${protocolSecure}://${hostname}:${port}/ws`;

        nfcLog(`NFC: Loading script from nfc-server.py at: ${scriptUrl}`);
        await dynamicallyLoadScript(scriptUrl);

        nfcLog(`NFC: Connecting to nfc-server.py at: ${scriptUrl}`);
        const nfc = new Nfc(connectionString, nfcEvent, exclusives, nfcLog);
        nfc.connect();
    } catch (error) {
        nfcLog(`NFC: Error - ${error.message}`);
    }
}




  </script>
</body>
</html>



<!-- the RFID reader interface isnt in the code yet as we are waiting on the order and to see if the order is here in time for the Spotlight day-->